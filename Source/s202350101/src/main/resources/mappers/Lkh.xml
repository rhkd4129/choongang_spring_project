<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oracle.s202350101.TaskMapper">


    <!---  도넛 그래프 그려주는  -->
    <select id="taskStatus_doughnut"  parameterType="int"  resultType="int">
    <![CDATA[
        select  count(*) as task_status_count from task
        where project_id = #{project_id}
        group by task_status
        order by TASK_STATUS
        ]]>
  </select>

    <!---진척루ㅠㄹ-->
    <select id="taskUserWorkload" parameterType="int" resultType="Task">
    <![CDATA[

        SELECT u.user_name,
               SUM(CASE WHEN t.task_status = 0 THEN 1 ELSE 0 END) AS status_0_count,
               SUM(CASE WHEN t.task_status = 1 THEN 1 ELSE 0 END) AS status_1_count,
               SUM(CASE WHEN t.task_status = 2 THEN 1 ELSE 0 END) AS status_2_count
        FROM TASK t  , USER_INFO u
        WHERE t.project_id = #{project_id} and t.user_id = u.user_id
        GROUP BY u.user_name
        ]]>
  </select>



    <!---유저이름과  프로젝트 단계이름까지 나오는거 -->
    <select id="taskList"  parameterType="int" resultType="Task">
        select u.user_name,p.project_s_name ,t.*
        from task t,  prj_step p , user_info u
        where  u.project_id = #{project_id} and
            t.user_id = u.user_id and
            t.project_id  = p.project_id and
            t.project_step_seq  = p.project_step_seq
    </select>



    <select id="task_detail" parameterType="int" resultType="Task">
        SELECT * FROM TASK
        WHERE project_id = #{project_id} and task_id = #{task_id}
    </select>


    <select id="task_detail2" parameterType="int" resultType="Task">
            select u.user_name,p.project_s_name ,t.*
            from task t,  prj_step p , user_info u
            where t.user_id = u.user_name and
            t.project_id  = p.project_id and
            t.project_step_seq  = p.project_step_seq and
            t.task_id = #{task_id} and t.project_id =#{project_id}
    </select>



    <select id="task_timeline" resultType="Task">
        select t.*,u.user_name   from task t, user_info u
        where t.user_id = u.user_id
    </select>




    <!-- -task create  -->

    <!--- GET  FORM-->
    <select id="task_create_form_step_list" parameterType="int" resultType="PrjStep">
        select  *  from prj_step
        where project_id = #{project_id}
    </select>


    <select id="task_create_form_worker_list" parameterType="int" resultType="Userinfo">
        select user_name, user_id from user_info
        where project_id =  #{project_id}
    </select>

    <!--- POST  FORM     TO_DATE('23/11/3', 'DD/MM/YY'), -->
    <insert id="task_create" parameterType="Task">
        INSERT INTO task (task_id, project_id, project_step_seq, user_id, task_subject, task_content, task_stat_time, task_end_itme, task_priority, task_status, garbage)
        SELECT COALESCE(MAX(task_id), 0) + 1, #{project_id}, #{project_step_seq}, #{user_id}, #{task_subject}, #{task_content}, #{task_stat_time} ,  #{task_end_itme},  #{task_priority}, #{task_status}, 0)
        FROM task
    </insert>

    <select id="maxTaskid_select" resultType="int">
        select max(task_id) from task
    </select>

    <insert id="task_worker_create" parameterType="java.util.List" >
        insert into Task_sub values
        <foreach collection="list" item="taskSub">
             (#{taskSub.task_id},#{taskSub.project_id}, #{taskSub.worker_id})
        </foreach>
    </insert>




    <!--같이 하는 작업자 목록들  -->
    <select id="taskWorkerlist"   parameterType="TaskSub" resultType="TaskSub">
        select w.worker_id,u.user_name
        from (select * from task_sub t where t.task_id =#{task_id} and t.project_id = #{project_id}) w , user_info u
        where u.user_id = w.worker_id
    </select>



</mapper>
